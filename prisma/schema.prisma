generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model NhanhCustomer {
  id           String           @id
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  name         String
  phone        String?
  email        String?
  totalSpent   Decimal          @default(0) @db.Decimal(18, 2)
  address      String?
  city         String?
  district     String?
  ward         String?
  lastPulledAt DateTime         @default(now())
  mapping      CustomerMapping?

  @@index([name])
  @@index([phone])
  @@index([email])
  @@index([totalSpent])
  @@index([lastPulledAt])
  @@map("nhanh_customers")
}

model CustomerMapping {
  id                   String        @id @default(cuid())
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  nhanhCustomerId      String        @unique
  nhanhCustomerName    String
  nhanhCustomerPhone   String?
  nhanhCustomerEmail   String?
  nhanhTotalSpent      Decimal       @default(0) @db.Decimal(18, 2)
  shopifyCustomerId    String?
  shopifyCustomerEmail String?
  shopifyCustomerName  String?
  syncStatus           SyncStatus    @default(UNMAPPED)
  lastSyncedAt         DateTime?
  syncError            String?
  syncAttempts         Int           @default(0)
  nhanhCustomer        NhanhCustomer @relation(fields: [nhanhCustomerId], references: [id], onDelete: Cascade)
  syncLogs             SyncLog[]

  @@index([nhanhCustomerId])
  @@index([shopifyCustomerId])
  @@index([syncStatus])
  @@map("customer_mappings")
}

model AutoSyncConfig {
  id        String   @id @default("global")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  enabled   Boolean  @default(false)
  schedule  String   @default("0 */6 * * *")

  @@map("auto_sync_config")
}

model PullProgress {
  id           String    @id
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  nextCursor   Json?
  totalPulled  Int       @default(0)
  lastPulledAt DateTime?
  isCompleted  Boolean   @default(false)
  metadata     String?   // Store filter signature for smart incremental pull

  @@map("pull_progress")
}

model SyncLog {
  id          String          @id @default(cuid())
  createdAt   DateTime        @default(now())
  mappingId   String
  action      SyncAction
  status      SyncStatus
  message     String?
  errorDetail String?
  metadata    Json?
  mapping     CustomerMapping @relation(fields: [mappingId], references: [id], onDelete: Cascade)

  @@index([mappingId])
  @@index([createdAt])
  @@map("sync_logs")
}

model ShopifyCustomer {
  id                 String   @id
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  email              String?
  firstName          String?
  lastName           String?
  phone              String?
  defaultAddressPhone String?
  note               String?  @db.Text
  totalSpent         Decimal  @default(0) @db.Decimal(18, 2)
  ordersCount        Int      @default(0)
  lastPulledAt       DateTime @default(now())

  @@index([phone])
  @@index([defaultAddressPhone])
  @@index([email])
  @@map("shopify_customers")
}

model WebhookLog {
  id          String    @id @default(cuid())
  createdAt   DateTime  @default(now())
  source      String
  eventType   String
  payload     Json
  processed   Boolean   @default(false)
  processedAt DateTime?
  error       String?

  @@index([source])
  @@index([processed])
  @@index([createdAt])
  @@map("webhook_logs")
}

model SaleCampaign {
  id              String         @id @default(cuid())
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  name            String
  description     String?
  status          CampaignStatus @default(DRAFT)
  discountType    DiscountType
  discountValue   Decimal        @db.Decimal(10, 2)
  targetType      TargetType
  targetIds       String[]
  productType     String?
  scheduleType    ScheduleType   @default(IMMEDIATE)
  startDate       DateTime?
  endDate         DateTime?
  appliedAt       DateTime?
  revertedAt      DateTime?
  affectedCount   Int            @default(0)
  errorMessage    String?
  collectionTitle String?
  priceChanges    PriceChange[]

  @@index([status])
  @@index([scheduleType])
  @@index([startDate])
  @@index([endDate])
  @@map("sale_campaigns")
}

model PriceChange {
  id                     String       @id @default(cuid())
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  campaignId             String
  productId              String
  variantId              String
  productTitle           String
  variantTitle           String?
  sku                    String?
  originalPrice          Decimal      @db.Decimal(10, 2)
  salePrice              Decimal      @db.Decimal(10, 2)
  currentPrice           Decimal      @db.Decimal(10, 2)
  applied                Boolean      @default(false)
  appliedAt              DateTime?
  reverted               Boolean      @default(false)
  revertedAt             DateTime?
  error                  String?
  originalCompareAtPrice Decimal?     @db.Decimal(10, 2)
  campaign               SaleCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([productId])
  @@index([variantId])
  @@index([applied])
  @@index([reverted])
  @@map("price_changes")
}

model NhanhProduct {
  id           String          @id
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  name         String
  sku          String?
  barcode      String?
  price        Decimal         @default(0) @db.Decimal(15, 2)
  comparePrice Decimal?        @db.Decimal(15, 2)
  quantity     Int             @default(0)
  categoryId   String?
  categoryName String?
  brandId      String?
  brandName    String?
  description  String?
  images       Json?
  lastPulledAt DateTime        @default(now())
  mapping      ProductMapping?

  @@index([name])
  @@index([sku])
  @@index([barcode])
  @@index([lastPulledAt])
  @@map("nhanh_products")
}

model ShopifyProduct {
  id                String   @id
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  title             String
  handle            String?
  productType       String?
  vendor            String?
  tags              String[]
  variantId         String?
  sku               String?
  barcode           String?
  price             Decimal  @default(0) @db.Decimal(15, 2)
  compareAtPrice    Decimal? @db.Decimal(15, 2)
  inventoryQuantity Int      @default(0)
  images            Json?
  lastPulledAt      DateTime @default(now())

  @@index([title])
  @@index([sku])
  @@index([barcode])
  @@index([lastPulledAt])
  @@map("shopify_products")
}

model ProductMapping {
  id                  String           @id @default(cuid())
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  nhanhProductId      String           @unique
  nhanhProductName    String
  nhanhSku            String?
  nhanhBarcode        String?
  nhanhPrice          Decimal          @default(0) @db.Decimal(15, 2)
  shopifyProductId    String?
  shopifyVariantId    String?
  shopifyProductTitle String?
  shopifySku          String?
  shopifyBarcode      String?
  syncStatus          SyncStatus       @default(UNMAPPED)
  lastSyncedAt        DateTime?
  syncError           String?
  syncAttempts        Int              @default(0)
  nhanhProduct        NhanhProduct     @relation(fields: [nhanhProductId], references: [id], onDelete: Cascade)
  syncLogs            ProductSyncLog[]

  @@index([nhanhProductId])
  @@index([shopifyProductId])
  @@index([syncStatus])
  @@map("product_mappings")
}

model ProductSyncLog {
  id          String         @id @default(cuid())
  createdAt   DateTime       @default(now())
  mappingId   String
  action      SyncAction
  status      SyncStatus
  message     String?
  errorDetail String?
  metadata    Json?
  mapping     ProductMapping @relation(fields: [mappingId], references: [id], onDelete: Cascade)

  @@index([mappingId])
  @@index([createdAt])
  @@map("product_sync_logs")
}

model SyncSchedule {
  id        String   @id
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  enabled   Boolean  @default(false)
  schedule  String
  type      String

  @@map("sync_schedules")
}

enum SyncStatus {
  UNMAPPED
  PENDING
  SYNCED
  FAILED
}

enum SyncAction {
  MANUAL_MAPPING
  MANUAL_SYNC
  AUTO_SYNC
  WEBHOOK_SYNC
  BULK_SYNC
  RETRY
  INVENTORY_UPDATE
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  COMPLETED
  CANCELLED
  FAILED
  APPLYING
  REVERTING
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum TargetType {
  PRODUCT
  COLLECTION
  PRODUCT_TYPE
  ALL
}

enum ScheduleType {
  IMMEDIATE
  SCHEDULED
}
